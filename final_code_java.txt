
==================== FILE: data/marketing-demo/src/main/java/com/icbc/marketing/DemoRunner.java ====================
package com.icbc.marketing;

import com.icbc.marketing.service.CampaignDecisionEngine;

import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

/**
 * [Simulator Entry Point]
 * This class simulates the environment where Flink calls our Engine.
 */
public class DemoRunner {

    public static void main(String[] args) {
        System.out.println(">>> Initializing ICBC Marketing Decision Engine...");
        
        // 1. 模拟加载配置 (假装读取 application.properties)
        loadConfiguration();

        // 2. 初始化引擎 (Service Layer)
        CampaignDecisionEngine engine = new CampaignDecisionEngine();

        // 3. 模拟 Case A: 普通用户 (将被 LegacyScoringUtil 拦截或计算低分)
        System.out.println("\n--- Case A: Processing Regular User ---");
        Map<String, Object> regularUserFeatures = new HashMap<>();
        regularUserFeatures.put("last_1h_txn_amt", 50.0);
        regularUserFeatures.put("login_count_7d", 2);
        regularUserFeatures.put("customer_segment", "REGULAR");
        
        String offerA = engine.decideOffer("U_1001", regularUserFeatures);
        System.out.println("Result for U_1001: " + offerA);

        // 4. 模拟 Case B: 高净值 VIP 用户 (将触发 HighNetWorthStrategy)
        System.out.println("\n--- Case B: Processing VIP User ---");
        Map<String, Object> vipFeatures = new HashMap<>();
        vipFeatures.put("last_1h_txn_amt", 50000.0);
        vipFeatures.put("login_count_7d", 20);
        vipFeatures.put("customer_segment", "VIP"); // 这里的 VIP 字符串对应 Strategy 里的判断
        
        String offerB = engine.decideOffer("U_8888", vipFeatures);
        System.out.println("Result for U_8888: " + offerB);

        // 5. 模拟 Case C: 黑名单用户 (触发 Risk Control)
        System.out.println("\n--- Case C: Processing Blacklisted User ---");
        String offerC = engine.decideOffer("B_BadGuy", regularUserFeatures);
        System.out.println("Result for B_BadGuy: " + offerC);
    }

    private static void loadConfiguration() {
        try (InputStream input = DemoRunner.class.getClassLoader().getResourceAsStream("application.properties")) {
            Properties prop = new Properties();
            if (input == null) {
                System.out.println("Sorry, unable to find application.properties");
                return;
            }
            prop.load(input);
            System.out.println("Loaded Config: Strategy Threshold = " + prop.getProperty("strategy.vip.threshold"));
        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }
}
==================== END FILE ====================


==================== FILE: data/marketing-demo/src/main/java/com/icbc/marketing/core/LegacyScoringUtil.java ====================
package com.icbc.marketing.core;

import java.util.Map;

/**
 * [Legacy Component]
 * A static utility class used across the system for basic scoring.
 * Refactoring Target: High coupling. If this changes, everything breaks.
 */
public class LegacyScoringUtil {

    // Magic number alert: 0.618
    private static final double GOLDEN_RATIO = 0.618;

    /**
     * Calculates a base user score.
     * @deprecated Logic is outdated, should be refactored to handle "Region" context.
     */
    public static double calculateBaseScore(Map<String, Object> flinkFeatures) {
        double txnVolume = (double) flinkFeatures.getOrDefault("last_1h_txn_amt", 0.0);
        int loginCount = (int) flinkFeatures.getOrDefault("login_count_7d", 0);

        // Simple linear hard-coded logic
        return (txnVolume * 0.001) + (loginCount * 10) * GOLDEN_RATIO;
    }

    public static boolean isBlacklisted(String userId) {
        // Mock DB call
        return userId.startsWith("B_");
    }
}
==================== END FILE ====================


==================== FILE: data/marketing-demo/src/main/java/com/icbc/marketing/service/CampaignDecisionEngine.java ====================
package com.icbc.marketing.service;

import com.icbc.marketing.core.LegacyScoringUtil;
import com.icbc.marketing.strategy.IPromotionStrategy;
import com.icbc.marketing.strategy.impl.HighNetWorthStrategy;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * [The Core System]
 * Real-time Decision Engine.
 * Responsibilities:
 * 1. Metric Analysis (Consume Flink data)
 * 2. Risk Pre-screening (Safety Guardrails) - 【风控在这里！】
 * 3. Marketing Strategy Execution (Recommendation) - 【推荐在这里！】
 */
public class CampaignDecisionEngine {

    private List<IPromotionStrategy> strategies;

    public CampaignDecisionEngine() {
        this.strategies = new ArrayList<>();
        this.strategies.add(new HighNetWorthStrategy());
    }

    public String decideOffer(String userId, Map<String, Object> realTimeFeatures) {
        System.out.println("Processing decision for user: " + userId);

        // =========================================================
        // Step 1: Risk Control Layer (Pre-computation) 【风控层】
        // =========================================================
        
        // 检查 1: 黑名单风控
        // The dependency graph should catch this reference to LegacyScoringUtil
        if (LegacyScoringUtil.isBlacklisted(userId)) {
            return "BLOCK: User is Blacklisted (Risk Control)";
        }

        // 检查 2: 基础指标门槛风控
        // The prompt will ask to refactor this method signature!
        // [Graph RAG Key Point]: If 'calculateBaseScore' changes, this line breaks.
        double baseScore = LegacyScoringUtil.calculateBaseScore(realTimeFeatures);
        
        if (baseScore < 0) {
            return "BLOCK: Activity Score too low (Metric Filter)";
        }

        // =========================================================
        // Step 2: Marketing Strategy Layer (Recommendation) 【推荐层】
        // =========================================================
        
        for (IPromotionStrategy strategy : strategies) {
            // Strategies ALSO depend on the metrics calculated above
            if (strategy.isApplicable(realTimeFeatures)) {
                return strategy.execute(userId, realTimeFeatures);
            }
        }

        return "DEFAULT: General Savings Promo";
    }
}
==================== END FILE ====================


==================== FILE: data/marketing-demo/src/main/java/com/icbc/marketing/strategy/IPromotionStrategy.java ====================
package com.icbc.marketing.strategy;

import java.util.Map;

public interface IPromotionStrategy {
    String getStrategyName();

    /**
     * Determines if the strategy applies to the current user context.
     */
    boolean isApplicable(Map<String, Object> realTimeFeatures);

    /**
     * Executes the strategy to generate an offer content.
     */
    String execute(String userId, Map<String, Object> context);
}
==================== END FILE ====================


==================== FILE: data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java ====================
package com.icbc.marketing.strategy;

import com.icbc.marketing.core.LegacyScoringUtil;
import java.util.Map;

public abstract class AbstractBaseStrategy implements IPromotionStrategy {

    protected double minScoreThreshold;

    public AbstractBaseStrategy(double minScoreThreshold) {
        this.minScoreThreshold = minScoreThreshold;
    }

    // Common logic shared by all subclasses
    protected boolean passBasicRiskCheck(Map<String, Object> features) {
        // DEPENDENCY ALERT: Calls the legacy static utility
        double currentScore = LegacyScoringUtil.calculateBaseScore(features);
        return currentScore > minScoreThreshold;
    }

    @Override
    public abstract String execute(String userId, Map<String, Object> context);
}
==================== END FILE ====================


==================== FILE: data/marketing-demo/src/main/java/com/icbc/marketing/strategy/impl/HighNetWorthStrategy.java ====================
package com.icbc.marketing.strategy.impl;

import com.icbc.marketing.strategy.AbstractBaseStrategy;
import java.util.Map;

public class HighNetWorthStrategy extends AbstractBaseStrategy {

    public HighNetWorthStrategy() {
        super(800.0); // Set high threshold
    }

    @Override
    public String getStrategyName() {
        return "VIP_WEALTH_MANAGEMENT";
    }

    @Override
    public boolean isApplicable(Map<String, Object> realTimeFeatures) {
        String segment = (String) realTimeFeatures.get("customer_segment");
        // Reuse the logic from parent, which calls LegacyScoringUtil
        return "VIP".equals(segment) && super.passBasicRiskCheck(realTimeFeatures);
    }

    @Override
    public String execute(String userId, Map<String, Object> context) {
        return "Offer: Exclusive Gold Deposit Rate + 2000 points";
    }
}
==================== END FILE ====================

