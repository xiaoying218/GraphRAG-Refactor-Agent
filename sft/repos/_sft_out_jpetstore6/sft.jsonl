{"messages": [{"role": "system", "content": "You are a code refactoring assistant. Output ONLY Search & Replace blocks."}, {"role": "user", "content": "Task: Refactor Java code using OpenRewrite recipe.\nRecipe: org.openrewrite.staticanalysis.CommonStaticAnalysis\nOutput format: Search & Replace blocks ONLY.\nFile: src/main/java/org/mybatis/jpetstore/domain/Cart.java\n\n--- BEFORE FILE CONTENT ---\n/*\n *    Copyright 2010-2022 the original author or authors.\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *       https://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\npackage org.mybatis.jpetstore.domain;\n\nimport java.io.Serializable;\nimport java.math.BigDecimal;\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * The Class Cart.\n *\n * @author Eduardo Macarron\n */\npublic class Cart implements Serializable {\n\n  private static final long serialVersionUID = 8329559983943337176L;\n\n  private final Map<String, CartItem> itemMap = Collections.synchronizedMap(new HashMap<>());\n  private final List<CartItem> itemList = new ArrayList<>();\n\n  public Iterator<CartItem> getCartItems() {\n    return itemList.iterator();\n  }\n\n  public List<CartItem> getCartItemList() {\n    return itemList;\n  }\n\n  public int getNumberOfItems() {\n    return itemList.size();\n  }\n\n  public Iterator<CartItem> getAllCartItems() {\n    return itemList.iterator();\n  }\n\n  public boolean containsItemId(String itemId) {\n    return itemMap.containsKey(itemId);\n  }\n\n  /**\n   * Adds the item.\n   *\n   * @param item\n   *          the item\n   * @param isInStock\n   *          the is in stock\n   */\n  public void addItem(Item item, boolean isInStock) {\n    CartItem cartItem = itemMap.get(item.getItemId());\n    if (cartItem == null) {\n      cartItem = new CartItem();\n      cartItem.setItem(item);\n      cartItem.setQuantity(0);\n      cartItem.setInStock(isInStock);\n      itemMap.put(item.getItemId(), cartItem);\n      itemList.add(cartItem);\n    }\n    cartItem.incrementQuantity();\n  }\n\n  /**\n   * Removes the item by id.\n   *\n   * @param itemId\n   *          the item id\n   *\n   * @return the item\n   */\n  public Item removeItemById(String itemId) {\n    CartItem cartItem = itemMap.remove(itemId);\n    if (cartItem == null) {\n      return null;\n    } else {\n      itemList.remove(cartItem);\n      return cartItem.getItem();\n    }\n  }\n\n  /**\n   * Increment quantity by item id.\n   *\n   * @param itemId\n   *          the item id\n   */\n  public void incrementQuantityByItemId(String itemId) {\n    CartItem cartItem = itemMap.get(itemId);\n    cartItem.incrementQuantity();\n  }\n\n  public void setQuantityByItemId(String itemId, int quantity) {\n    CartItem cartItem = itemMap.get(itemId);\n    cartItem.setQuantity(quantity);\n  }\n\n  /**\n   * Gets the sub total.\n   *\n   * @return the sub total\n   */\n  public BigDecimal getSubTotal() {\n    return itemList.stream()\n        .map(cartItem -> cartItem.getItem().getListPrice().multiply(new BigDecimal(cartItem.getQuantity())))\n        .reduce(BigDecimal.ZERO, BigDecimal::add);\n  }\n\n}\n\n"}, {"role": "assistant", "content": "### FILE: src/main/java/org/mybatis/jpetstore/domain/Cart.java\n<<<< SEARCH\n  public BigDecimal getSubTotal() {\n    return itemList.stream()\n        .map(cartItem -> cartItem.getItem().getListPrice().multiply(new BigDecimal(cartItem.getQuantity())))\n        .reduce(BigDecimal.ZERO, BigDecimal::add);\n  }\n==== REPLACE\n  public BigDecimal getSubTotal() {\n    return itemList.stream()\n        .map(cartItem -> cartItem.getItem().getListPrice().multiply(BigDecimal.valueOf(cartItem.getQuantity())))\n        .reduce(BigDecimal.ZERO, BigDecimal::add);\n  }\n>>>> END\n"}]}
{"messages": [{"role": "system", "content": "You are a code refactoring assistant. Output ONLY Search & Replace blocks."}, {"role": "user", "content": "Task: Refactor Java code using OpenRewrite recipe.\nRecipe: org.openrewrite.staticanalysis.CommonStaticAnalysis\nOutput format: Search & Replace blocks ONLY.\nFile: src/main/java/org/mybatis/jpetstore/domain/CartItem.java\n\n--- BEFORE FILE CONTENT ---\n/*\n *    Copyright 2010-2022 the original author or authors.\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *       https://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\npackage org.mybatis.jpetstore.domain;\n\nimport java.io.Serializable;\nimport java.math.BigDecimal;\nimport java.util.Optional;\n\n/**\n * The Class CartItem.\n *\n * @author Eduardo Macarron\n */\npublic class CartItem implements Serializable {\n\n  private static final long serialVersionUID = 6620528781626504362L;\n\n  private Item item;\n  private int quantity;\n  private boolean inStock;\n  private BigDecimal total;\n\n  public boolean isInStock() {\n    return inStock;\n  }\n\n  public void setInStock(boolean inStock) {\n    this.inStock = inStock;\n  }\n\n  public BigDecimal getTotal() {\n    return total;\n  }\n\n  public Item getItem() {\n    return item;\n  }\n\n  public void setItem(Item item) {\n    this.item = item;\n    calculateTotal();\n  }\n\n  public int getQuantity() {\n    return quantity;\n  }\n\n  public void setQuantity(int quantity) {\n    this.quantity = quantity;\n    calculateTotal();\n  }\n\n  public void incrementQuantity() {\n    quantity++;\n    calculateTotal();\n  }\n\n  private void calculateTotal() {\n    total = Optional.ofNullable(item).map(Item::getListPrice).map(v -> v.multiply(new BigDecimal(quantity)))\n        .orElse(null);\n  }\n\n}\n\n"}, {"role": "assistant", "content": "### FILE: src/main/java/org/mybatis/jpetstore/domain/CartItem.java\n<<<< SEARCH\n\n  private void calculateTotal() {\n    total = Optional.ofNullable(item).map(Item::getListPrice).map(v -> v.multiply(new BigDecimal(quantity)))\n        .orElse(null);\n  }\n==== REPLACE\n\n  private void calculateTotal() {\n    total = Optional.ofNullable(item).map(Item::getListPrice).map(v -> v.multiply(BigDecimal.valueOf(quantity)))\n        .orElse(null);\n  }\n>>>> END\n"}]}
{"messages": [{"role": "system", "content": "You are a code refactoring assistant. Output ONLY Search & Replace blocks."}, {"role": "user", "content": "Task: Refactor Java code using OpenRewrite recipe.\nRecipe: org.openrewrite.staticanalysis.CommonStaticAnalysis\nOutput format: Search & Replace blocks ONLY.\nFile: src/main/java/org/mybatis/jpetstore/domain/LineItem.java\n\n--- BEFORE FILE CONTENT ---\n/*\n *    Copyright 2010-2022 the original author or authors.\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *       https://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\npackage org.mybatis.jpetstore.domain;\n\nimport java.io.Serializable;\nimport java.math.BigDecimal;\nimport java.util.Optional;\n\n/**\n * The Class LineItem.\n *\n * @author Eduardo Macarron\n */\npublic class LineItem implements Serializable {\n\n  private static final long serialVersionUID = 6804536240033522156L;\n\n  private int orderId;\n  private int lineNumber;\n  private int quantity;\n  private String itemId;\n  private BigDecimal unitPrice;\n  private Item item;\n  private BigDecimal total;\n\n  public LineItem() {\n  }\n\n  /**\n   * Instantiates a new line item.\n   *\n   * @param lineNumber\n   *          the line number\n   * @param cartItem\n   *          the cart item\n   */\n  public LineItem(int lineNumber, CartItem cartItem) {\n    this.lineNumber = lineNumber;\n    this.quantity = cartItem.getQuantity();\n    this.itemId = cartItem.getItem().getItemId();\n    this.unitPrice = cartItem.getItem().getListPrice();\n    this.item = cartItem.getItem();\n    calculateTotal();\n  }\n\n  public int getOrderId() {\n    return orderId;\n  }\n\n  public void setOrderId(int orderId) {\n    this.orderId = orderId;\n  }\n\n  public int getLineNumber() {\n    return lineNumber;\n  }\n\n  public void setLineNumber(int lineNumber) {\n    this.lineNumber = lineNumber;\n  }\n\n  public String getItemId() {\n    return itemId;\n  }\n\n  public void setItemId(String itemId) {\n    this.itemId = itemId;\n  }\n\n  public BigDecimal getUnitPrice() {\n    return unitPrice;\n  }\n\n  public void setUnitPrice(BigDecimal unitprice) {\n    this.unitPrice = unitprice;\n  }\n\n  public BigDecimal getTotal() {\n    return total;\n  }\n\n  public Item getItem() {\n    return item;\n  }\n\n  public void setItem(Item item) {\n    this.item = item;\n    calculateTotal();\n  }\n\n  public int getQuantity() {\n    return quantity;\n  }\n\n  public void setQuantity(int quantity) {\n    this.quantity = quantity;\n    calculateTotal();\n  }\n\n  private void calculateTotal() {\n    total = Optional.ofNullable(item).map(Item::getListPrice).map(v -> v.multiply(new BigDecimal(quantity)))\n        .orElse(null);\n  }\n\n}\n\n"}, {"role": "assistant", "content": "### FILE: src/main/java/org/mybatis/jpetstore/domain/LineItem.java\n<<<< SEARCH\n\n  private void calculateTotal() {\n    total = Optional.ofNullable(item).map(Item::getListPrice).map(v -> v.multiply(new BigDecimal(quantity)))\n        .orElse(null);\n  }\n==== REPLACE\n\n  private void calculateTotal() {\n    total = Optional.ofNullable(item).map(Item::getListPrice).map(v -> v.multiply(BigDecimal.valueOf(quantity)))\n        .orElse(null);\n  }\n>>>> END\n"}]}
{"messages": [{"role": "system", "content": "You are a code refactoring assistant. Output ONLY Search & Replace blocks."}, {"role": "user", "content": "Task: Refactor Java code using OpenRewrite recipe.\nRecipe: org.openrewrite.staticanalysis.CommonStaticAnalysis\nOutput format: Search & Replace blocks ONLY.\nFile: src/test/java/org/mybatis/jpetstore/service/OrderServiceTest.java\n\n--- BEFORE FILE CONTENT ---\n/*\n *    Copyright 2010-2023 the original author or authors.\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *       https://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\npackage org.mybatis.jpetstore.service;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.assertj.core.api.Assertions.fail;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\n\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\n\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.mybatis.jpetstore.domain.Item;\nimport org.mybatis.jpetstore.domain.LineItem;\nimport org.mybatis.jpetstore.domain.Order;\nimport org.mybatis.jpetstore.domain.Sequence;\nimport org.mybatis.jpetstore.mapper.ItemMapper;\nimport org.mybatis.jpetstore.mapper.LineItemMapper;\nimport org.mybatis.jpetstore.mapper.OrderMapper;\nimport org.mybatis.jpetstore.mapper.SequenceMapper;\n\n/**\n * @author coderliux\n */\n@ExtendWith(MockitoExtension.class)\nclass OrderServiceTest {\n\n  @Mock\n  private ItemMapper itemMapper;\n  @Mock\n  private OrderMapper orderMapper;\n  @Mock\n  private LineItemMapper lineItemMapper;\n  @Mock\n  private SequenceMapper sequenceMapper;\n\n  @InjectMocks\n  private OrderService orderService;\n\n  @Test\n  void shouldReturnOrderWhenGivenOrderIdWithOutLineItems() {\n    // given\n    int orderId = 1;\n    Order order = new Order();\n    List<LineItem> lineItems = new ArrayList<>();\n\n    // when\n    when(orderMapper.getOrder(orderId)).thenReturn(order);\n    when(lineItemMapper.getLineItemsByOrderId(orderId)).thenReturn(lineItems);\n\n    // then\n    assertThat(orderService.getOrder(orderId)).isEqualTo(order);\n    assertThat(orderService.getOrder(orderId).getLineItems()).isEmpty();\n  }\n\n  @Test\n  void shouldReturnOrderWhenGivenOrderIdExistedLineItems() {\n    // given\n    int orderId = 1;\n    Order order = new Order();\n    List<LineItem> lineItems = new ArrayList<>();\n    LineItem item = new LineItem();\n    String itemId = \"abc\";\n    item.setItemId(itemId);\n    lineItems.add(item);\n\n    // when\n    when(orderMapper.getOrder(orderId)).thenReturn(order);\n    when(lineItemMapper.getLineItemsByOrderId(orderId)).thenReturn(lineItems);\n    when(itemMapper.getItem(itemId)).thenReturn(new Item());\n    when(itemMapper.getInventoryQuantity(itemId)).thenReturn(5);\n\n    // then\n    Order expectedOrder = orderService.getOrder(orderId);\n    assertThat(expectedOrder).isEqualTo(order);\n    assertThat(expectedOrder.getLineItems()).hasSize(1);\n    assertThat(expectedOrder.getLineItems().get(0).getItem().getQuantity()).isEqualTo(5);\n  }\n\n  @Test\n  void shouldReturnOrderList() {\n\n    // given\n    String username = \"foo\";\n    List<Order> expectedOrders = new ArrayList<>();\n\n    // when\n    when(orderMapper.getOrdersByUsername(username)).thenReturn(expectedOrders);\n    List<Order> orders = orderService.getOrdersByUsername(username);\n\n    // then\n    assertThat(orders).isSameAs(expectedOrders);\n\n  }\n\n  @Test\n  void shouldReturnNextId() {\n\n    // given\n    Sequence expectedSequence = new Sequence(\"order\", 100);\n\n    // when\n    when(sequenceMapper.getSequence(any())).thenReturn(expectedSequence);\n    int nextId = orderService.getNextId(\"order\");\n\n    // then\n    assertThat(nextId).isEqualTo(100);\n    verify(sequenceMapper).getSequence(argThat(v -> v.getName().equals(\"order\") && v.getNextId() == -1));\n    verify(sequenceMapper).updateSequence(argThat(v -> v.getName().equals(\"order\") && v.getNextId() == 101));\n\n  }\n\n  @Test\n  void shouldThrowExceptionWhenSequenceNotFound() {\n\n    // given\n\n    // when\n    when(sequenceMapper.getSequence(any())).thenReturn(null);\n    try {\n      orderService.getNextId(\"order\");\n      fail(\"Should throw an exception when sequence not found.\");\n    } catch (RuntimeException e) {\n      // then\n      assertThat(e.getMessage())\n          .isEqualTo(\"Error: A null sequence was returned from the database (could not get next order sequence).\");\n      verify(sequenceMapper).getSequence(argThat(v -> v.getName().equals(\"order\") && v.getNextId() == -1));\n    }\n\n  }\n\n  @Test\n  void shouldCallTheMapperToInsert() {\n    // given\n    Order order = new Order();\n    LineItem item = new LineItem();\n    String itemId = \"I01\";\n    int quantity = 4;\n    item.setItemId(itemId);\n    item.setQuantity(quantity);\n    order.addLineItem(item);\n\n    Sequence orderNumSequence = new Sequence(\"ordernum\", 100);\n\n    Map<String, Object> expectedItemParam = new HashMap<>(2);\n    expectedItemParam.put(\"itemId\", itemId);\n    expectedItemParam.put(\"increment\", quantity);\n\n    // when\n    when(sequenceMapper.getSequence(any())).thenReturn(orderNumSequence);\n    orderService.insertOrder(order);\n\n    // then\n    verify(orderMapper).insertOrder(argThat(v -> v == order && v.getOrderId() == 100));\n    verify(orderMapper).insertOrderStatus(eq(order));\n    verify(lineItemMapper).insertLineItem(argThat(v -> v == item && v.getOrderId() == 100));\n    verify(itemMapper).updateInventoryQuantity(eq(expectedItemParam));\n  }\n\n}\n\n"}, {"role": "assistant", "content": "### FILE: src/test/java/org/mybatis/jpetstore/service/OrderServiceTest.java\n<<<< SEARCH\n    // then\n    assertThat(nextId).isEqualTo(100);\n    verify(sequenceMapper).getSequence(argThat(v -> v.getName().equals(\"order\") && v.getNextId() == -1));\n    verify(sequenceMapper).updateSequence(argThat(v -> v.getName().equals(\"order\") && v.getNextId() == 101));\n\n  }\n==== REPLACE\n    // then\n    assertThat(nextId).isEqualTo(100);\n    verify(sequenceMapper).getSequence(argThat(v -> \"order\".equals(v.getName()) && v.getNextId() == -1));\n    verify(sequenceMapper).updateSequence(argThat(v -> \"order\".equals(v.getName()) && v.getNextId() == 101));\n\n  }\n>>>> END\n\n### FILE: src/test/java/org/mybatis/jpetstore/service/OrderServiceTest.java\n<<<< SEARCH\n      assertThat(e.getMessage())\n          .isEqualTo(\"Error: A null sequence was returned from the database (could not get next order sequence).\");\n      verify(sequenceMapper).getSequence(argThat(v -> v.getName().equals(\"order\") && v.getNextId() == -1));\n    }\n\n==== REPLACE\n      assertThat(e.getMessage())\n          .isEqualTo(\"Error: A null sequence was returned from the database (could not get next order sequence).\");\n      verify(sequenceMapper).getSequence(argThat(v -> \"order\".equals(v.getName()) && v.getNextId() == -1));\n    }\n\n>>>> END\n"}]}
