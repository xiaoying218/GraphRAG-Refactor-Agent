{
  "query": "passBasicRiskCheck",
  "focus_node": "AbstractBaseStrategy.passBasicRiskCheck",
  "seed_nodes": [
    {
      "node_id": "AbstractBaseStrategy.passBasicRiskCheck",
      "score": 0.7201116983603292
    },
    {
      "node_id": "LegacyScoringUtil",
      "score": 0.029342390010612365
    },
    {
      "node_id": "CampaignDecisionEngine",
      "score": 0.02826898977874967
    }
  ],
  "nodes": [
    {
      "node_id": "AbstractBaseStrategy.passBasicRiskCheck",
      "name": "passBasicRiskCheck",
      "type": "Method",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java",
      "start_line": 15,
      "end_line": 19,
      "signature": "protected boolean passBasicRiskCheck(Map<String, Object> features)",
      "docstring": "// Common logic shared by all subclasses",
      "snippet": "    protected boolean passBasicRiskCheck(Map<String, Object> features) {\n        // DEPENDENCY ALERT: Calls the legacy static utility\n        double currentScore = LegacyScoringUtil.calculateBaseScore(features);\n        return currentScore > minScoreThreshold;\n    }\n",
      "role": "focus",
      "roles": [
        "focus",
        "same_class_member",
        "same_file_helper",
        "seed"
      ],
      "highlight_span": {
        "start_line": 15,
        "end_line": 15
      },
      "why": [
        "focus node",
        "seed via vector search (score=0.720)",
        "same class member of AbstractBaseStrategy",
        "same file helper (/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java)"
      ]
    },
    {
      "node_id": "CampaignDecisionEngine",
      "name": "CampaignDecisionEngine",
      "type": "Class",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/service/CampaignDecisionEngine.java",
      "start_line": 18,
      "end_line": 62,
      "signature": "public class CampaignDecisionEngine",
      "docstring": "/**\n * [The Core System]\n * Real-time Decision Engine.\n * Responsibilities:\n * 1. Metric Analysis (Consume Flink data)\n * 2. Risk Pre-screening (Safety Guardrails) - 【风控在这里！】\n * 3. Marketing Strategy Execution (Recommendation) - 【推荐在这里！】\n */",
      "snippet": "public class CampaignDecisionEngine {\n\n    private List<IPromotionStrategy> strategies;\n\n    public CampaignDecisionEngine() {\n        this.strategies = new ArrayList<>();\n        this.strategies.add(new HighNetWorthStrategy());\n    }\n\n    public String decideOffer(String userId, Map<String, Object> realTimeFeatures) {\n        System.out.println(\"Processing decision for user: \" + userId);\n\n        // =========================================================\n        // Step 1: Risk Control Layer (Pre-computation) 【风控层】\n        // =========================================================\n        \n        // 检查 1: 黑名单风控\n        // The dependency graph should catch this reference to LegacyScoringUtil\n        if (LegacyScoringUtil.isBlacklisted(userId)) {\n            return \"BLOCK: User is Blacklisted (Risk Control)\";\n        }\n\n        // 检查 2: 基础指标门槛风控\n        // The prompt will ask to refactor this method signature!\n        // [Graph RAG Key Point]: If 'calculateBaseScore' changes, this line breaks.\n        double baseScore = LegacyScoringUtil.calculateBaseScore(realTimeFeatures);\n        \n        if (baseScore < 0) {\n            return \"BLOCK: Activity Score too low (Metric Filter)\";\n        }\n\n        // =========================================================\n        // Step 2: Marketing Strategy Layer (Recommendation) 【推荐层】\n        // =========================================================\n        \n        for (IPromotionStrategy strategy : strategies) {\n            // Strategies ALSO depend on the metrics calculated above\n            if (strategy.isApplicable(realTimeFeatures)) {\n                return strategy.execute(userId, realTimeFeatures);\n            }\n        }\n\n        return \"DEFAULT: General Savings Promo\";\n    }\n}",
      "role": "seed",
      "roles": [
        "seed"
      ],
      "highlight_span": {
        "start_line": 18,
        "end_line": 18
      },
      "why": [
        "seed via vector search (score=0.028)"
      ]
    },
    {
      "node_id": "LegacyScoringUtil",
      "name": "LegacyScoringUtil",
      "type": "Class",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/core/LegacyScoringUtil.java",
      "start_line": 10,
      "end_line": 31,
      "signature": "public class LegacyScoringUtil",
      "docstring": "/**\n * [Legacy Component]\n * A static utility class used across the system for basic scoring.\n * Refactoring Target: High coupling. If this changes, everything breaks.\n */",
      "snippet": "public class LegacyScoringUtil {\n\n    // Magic number alert: 0.618\n    private static final double GOLDEN_RATIO = 0.618;\n\n    /**\n     * Calculates a base user score.\n     * @deprecated Logic is outdated, should be refactored to handle \"Region\" context.\n     */\n    public static double calculateBaseScore(Map<String, Object> flinkFeatures) {\n        double txnVolume = (double) flinkFeatures.getOrDefault(\"last_1h_txn_amt\", 0.0);\n        int loginCount = (int) flinkFeatures.getOrDefault(\"login_count_7d\", 0);\n\n        // Simple linear hard-coded logic\n        return (txnVolume * 0.001) + (loginCount * 10) * GOLDEN_RATIO;\n    }\n\n    public static boolean isBlacklisted(String userId) {\n        // Mock DB call\n        return userId.startsWith(\"B_\");\n    }\n}",
      "role": "seed",
      "roles": [
        "seed"
      ],
      "highlight_span": {
        "start_line": 10,
        "end_line": 10
      },
      "why": [
        "seed via vector search (score=0.029)"
      ]
    },
    {
      "node_id": "EXTERNAL::Map.getOrDefault",
      "name": "Map.getOrDefault",
      "type": "External",
      "file_path": "",
      "start_line": 0,
      "end_line": 0,
      "signature": "",
      "docstring": "",
      "snippet": "",
      "role": "callee",
      "roles": [
        "callee"
      ],
      "highlight_span": null,
      "why": [
        "call-graph neighbor (CALLEE, depth=2)"
      ]
    },
    {
      "node_id": "HighNetWorthStrategy.isApplicable",
      "name": "isApplicable",
      "type": "Method",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/impl/HighNetWorthStrategy.java",
      "start_line": 17,
      "end_line": 22,
      "signature": "@Override public boolean isApplicable(Map<String, Object> realTimeFeatures)",
      "docstring": "",
      "snippet": "    @Override\n    public boolean isApplicable(Map<String, Object> realTimeFeatures) {\n        String segment = (String) realTimeFeatures.get(\"customer_segment\");\n        // Reuse the logic from parent, which calls LegacyScoringUtil\n        return \"VIP\".equals(segment) && super.passBasicRiskCheck(realTimeFeatures);\n    }\n",
      "role": "caller",
      "roles": [
        "caller"
      ],
      "highlight_span": {
        "start_line": 18,
        "end_line": 18
      },
      "why": [
        "call-graph neighbor (CALLER, depth=1)"
      ]
    },
    {
      "node_id": "LegacyScoringUtil.calculateBaseScore",
      "name": "calculateBaseScore",
      "type": "Method",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/core/LegacyScoringUtil.java",
      "start_line": 19,
      "end_line": 25,
      "signature": "public static double calculateBaseScore(Map<String, Object> flinkFeatures)",
      "docstring": "/**\n     * Calculates a base user score.\n     * @deprecated Logic is outdated, should be refactored to handle \"Region\" context.\n     */",
      "snippet": "    public static double calculateBaseScore(Map<String, Object> flinkFeatures) {\n        double txnVolume = (double) flinkFeatures.getOrDefault(\"last_1h_txn_amt\", 0.0);\n        int loginCount = (int) flinkFeatures.getOrDefault(\"login_count_7d\", 0);\n\n        // Simple linear hard-coded logic\n        return (txnVolume * 0.001) + (loginCount * 10) * GOLDEN_RATIO;\n    }\n",
      "role": "callee",
      "roles": [
        "callee"
      ],
      "highlight_span": {
        "start_line": 19,
        "end_line": 19
      },
      "why": [
        "call-graph neighbor (CALLEE, depth=1)"
      ]
    },
    {
      "node_id": "AbstractBaseStrategy.execute",
      "name": "execute",
      "type": "Method",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java",
      "start_line": 21,
      "end_line": 22,
      "signature": "@Override public abstract String execute(String userId, Map<String, Object> context);",
      "docstring": "",
      "snippet": "    @Override\n    public abstract String execute(String userId, Map<String, Object> context);\n",
      "role": "same_class_member",
      "roles": [
        "same_class_member",
        "same_file_helper"
      ],
      "highlight_span": {
        "start_line": 22,
        "end_line": 22
      },
      "why": [
        "same class member of AbstractBaseStrategy",
        "same file helper (/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java)"
      ]
    },
    {
      "node_id": "AbstractBaseStrategy.minScoreThreshold",
      "name": "minScoreThreshold",
      "type": "Field",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java",
      "start_line": 8,
      "end_line": 8,
      "signature": "double minScoreThreshold",
      "docstring": "",
      "snippet": "    protected double minScoreThreshold;\n",
      "role": "same_class_member",
      "roles": [
        "same_class_member",
        "same_file_helper"
      ],
      "highlight_span": {
        "start_line": 8,
        "end_line": 8
      },
      "why": [
        "same class member of AbstractBaseStrategy",
        "same file helper (/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java)"
      ]
    },
    {
      "node_id": "AbstractBaseStrategy",
      "name": "AbstractBaseStrategy",
      "type": "Class",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java",
      "start_line": 6,
      "end_line": 23,
      "signature": "public abstract class AbstractBaseStrategy implements IPromotionStrategy",
      "docstring": "",
      "snippet": "public abstract class AbstractBaseStrategy implements IPromotionStrategy {\n\n    protected double minScoreThreshold;\n\n    public AbstractBaseStrategy(double minScoreThreshold) {\n        this.minScoreThreshold = minScoreThreshold;\n    }\n\n    // Common logic shared by all subclasses\n    protected boolean passBasicRiskCheck(Map<String, Object> features) {\n        // DEPENDENCY ALERT: Calls the legacy static utility\n        double currentScore = LegacyScoringUtil.calculateBaseScore(features);\n        return currentScore > minScoreThreshold;\n    }\n\n    @Override\n    public abstract String execute(String userId, Map<String, Object> context);\n}",
      "role": "same_file_helper",
      "roles": [
        "same_file_helper"
      ],
      "highlight_span": {
        "start_line": 6,
        "end_line": 6
      },
      "why": [
        "same file helper (/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java)"
      ]
    }
  ],
  "edges": [
    {
      "source": "LegacyScoringUtil",
      "target": "LegacyScoringUtil.calculateBaseScore",
      "relation": "CONTAINS",
      "file_path": null,
      "line": null
    },
    {
      "source": "AbstractBaseStrategy",
      "target": "AbstractBaseStrategy.minScoreThreshold",
      "relation": "CONTAINS",
      "file_path": null,
      "line": null
    },
    {
      "source": "AbstractBaseStrategy",
      "target": "AbstractBaseStrategy.execute",
      "relation": "CONTAINS",
      "file_path": null,
      "line": null
    },
    {
      "source": "AbstractBaseStrategy",
      "target": "AbstractBaseStrategy.passBasicRiskCheck",
      "relation": "CONTAINS",
      "file_path": null,
      "line": null
    },
    {
      "source": "LegacyScoringUtil.calculateBaseScore",
      "target": "EXTERNAL::Map.getOrDefault",
      "relation": "CALLS",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/core/LegacyScoringUtil.java",
      "line": 20
    },
    {
      "source": "AbstractBaseStrategy.passBasicRiskCheck",
      "target": "LegacyScoringUtil.calculateBaseScore",
      "relation": "CALLS",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/AbstractBaseStrategy.java",
      "line": 17
    },
    {
      "source": "HighNetWorthStrategy.isApplicable",
      "target": "AbstractBaseStrategy.passBasicRiskCheck",
      "relation": "CALLS",
      "file_path": "/Users/lixiaoying/lxy/code/Code Refactoring/graph_rag_context_engine/data/marketing-demo/src/main/java/com/icbc/marketing/strategy/impl/HighNetWorthStrategy.java",
      "line": 21
    }
  ],
  "focus": {
    "node_id": "AbstractBaseStrategy.passBasicRiskCheck"
  },
  "call_graph": {
    "callees": [
      {
        "node_id": "LegacyScoringUtil.calculateBaseScore",
        "depth": 1
      },
      {
        "node_id": "EXTERNAL::Map.getOrDefault",
        "depth": 2
      }
    ],
    "callers": [
      {
        "node_id": "HighNetWorthStrategy.isApplicable",
        "depth": 1
      }
    ]
  },
  "data_flow": {
    "read_fields": [],
    "written_fields": []
  },
  "same_class": [
    "AbstractBaseStrategy",
    "AbstractBaseStrategy.execute",
    "AbstractBaseStrategy.minScoreThreshold",
    "AbstractBaseStrategy.passBasicRiskCheck"
  ],
  "same_file": [
    "AbstractBaseStrategy",
    "AbstractBaseStrategy.execute",
    "AbstractBaseStrategy.minScoreThreshold",
    "AbstractBaseStrategy.passBasicRiskCheck"
  ],
  "stats": {
    "seed_top_k": 5,
    "hops": 2,
    "selected_nodes": 9,
    "selected_edges": 7
  }
}